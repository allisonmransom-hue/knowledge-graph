<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Graph Search Explorer</title>

  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <style>
    :root { --border:#ddd; --muted:#666; --bg:#fff; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); }

    header { padding: 14px; border-bottom: 1px solid var(--border); display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, select {
      padding: 10px 12px; font-size: 16px; border: 1px solid var(--border);
      border-radius: 10px;
    }
    input { width: min(520px, 100%); }
    button {
      padding: 10px 14px; font-size: 15px; cursor: pointer;
      border: 1px solid var(--border); background: #fff; border-radius: 10px;
    }
    button:hover { background: #f7f7f7; }
    .hint { color: var(--muted); font-size: 13px; }
    #status { color: #333; font-size: 14px; }
    .pill { padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; font-size: 12px; background: #fafafa; }

    /* Layout: graph + right panel */
    .main {
      display: grid;
      grid-template-columns: 1fr 360px;
      height: calc(100vh - 190px);
      min-height: 420px;
    }
    #cy { width: 100%; height: 100%; border-right: 1px solid var(--border); }

    /* Details panel */
    .panel {
      height: 100%;
      overflow: auto;
      padding: 14px;
    }
    .panel h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .panel .sub {
      color: var(--muted);
      font-size: 12px;
      word-break: break-all;
      margin-bottom: 12px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
      background: #fff;
    }
    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 10px;
      align-items: start;
      font-size: 13px;
    }
    .k {
      color: var(--muted);
      word-break: break-word;
    }
    .v {
      word-break: break-word;
    }
    .v a { color: inherit; text-decoration: underline; cursor: pointer; }
    .badge {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
      background: #fafafa;
      cursor: pointer;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    /* Small screens: stack */
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      #cy { border-right: none; border-bottom: 1px solid var(--border); height: 60vh; }
    }
  </style>
</head>

<body>
<header>
  <div class="row">
    <strong>Search:</strong>
    <input id="q" type="text" placeholder="e.g. psychology" />
    <select id="field">
      <option value="title" selected>Title</option>
      <option value="subject">Subject</option>
      <option value="any">Any field</option>
    </select>
    <button id="searchBtn">Search</button>
    <button id="clearBtn">Clear</button>
    <button id="fitBtn">Fit</button>
    <span class="pill" id="endpointPill"></span>
  </div>

  <div class="row">
    <span class="hint">
      Search returns <b>books only</b>. Click a <b>book</b> to reveal its <b>subjects</b> and load the full record in the panel.
      Click a <b>subject</b> to load more books in that subject.
    </span>
  </div>

  <div id="status"></div>
</header>

<div class="main">
  <div id="cy"></div>

  <aside class="panel" id="panel">
    <div class="card">
      <h2>Book details</h2>
      <div class="sub">Click a book node to see all associated data here.</div>
      <div class="hint">
        Tip: In the details panel, you can click subject/value chips to explore related books.
      </div>
    </div>
  </aside>
</div>

<script>
/**
 * Search-first graph explorer + Details side panel (TriplyDB SPARQL + Cytoscape)
 */

const ENDPOINT = "https://api.triplydb.com/datasets/Allisonmransom/deleted-records-knowledge-graph/sparql";
document.getElementById("endpointPill").textContent = ENDPOINT;

const qEl = document.getElementById("q");
const fieldEl = document.getElementById("field");
const statusEl = document.getElementById("status");
const panelEl = document.getElementById("panel");

function status(msg) { statusEl.textContent = msg; }

const cy = cytoscape({
  container: document.getElementById("cy"),
  elements: [],
  style: [
    { selector: "node", style: {
        "label": "data(label)",
        "text-wrap": "wrap",
        "text-max-width": 190,
        "font-size": 11
      }
    },
    { selector: "node.term", style: { "font-size": 13, "border-width": 2 } },
    { selector: "node.subject", style: { "border-width": 2 } },
    { selector: "edge", style: {
        "label": "data(label)",
        "font-size": 10,
        "curve-style": "bezier",
        "target-arrow-shape": "triangle"
      }
    },
    { selector: ":selected", style: { "border-width": 4 } }
  ],
  layout: { name: "cose", animate: false }
});

function relayout() {
  cy.layout({ name: "cose", animate: false }).run();
  cy.fit();
}

function esc(str) {
  return String(str).replace(/\\/g, "\\\\").replace(/"/g, '\\"');
}

/** Friendly labels for URIs and literals */
function shortLabel(v) {
  if (!v) return "";
  if (v.startsWith("http://") || v.startsWith("https://")) {
    const hash = v.lastIndexOf("#");
    const slash = v.lastIndexOf("/");
    const cut = Math.max(hash, slash);
    let frag = decodeURIComponent(v.slice(cut + 1)) || v;

    frag = frag.replace(/^Subject[_-]/i, "");
    frag = frag.replace(/^subj[_-]/i, "");
    frag = frag.replace(/_/g, " ");
    frag = frag.replace(/\s+/g, " ").trim();
    frag = frag.replace(/\b\w/g, c => c.toUpperCase());

    return frag || v;
  }
  return v.length > 120 ? v.slice(0, 117) + "…" : v;
}

function ensureNode(id, label, classes, extra={}) {
  if (cy.getElementById(id).empty()) {
    cy.add({ data: { id, label, ...extra }, classes });
  }
}

function ensureEdge(id, source, target, label) {
  if (cy.getElementById(id).empty()) {
    cy.add({ data: { id, source, target, label } });
  }
}

async function sparql(query) {
  const url = ENDPOINT + "?query=" + encodeURIComponent(query);
  const resp = await fetch(url, { headers: { "Accept": "application/sparql-results+json" } });
  const text = await resp.text();
  if (!resp.ok) {
    console.error("HTTP", resp.status, text);
    throw new Error(`HTTP ${resp.status}. See console.`);
  }
  if (text.trim().startsWith("<")) {
    console.error("HTML instead of JSON:", text.slice(0, 400));
    throw new Error("Endpoint returned HTML (auth/access issue).");
  }
  return JSON.parse(text);
}

/**
 * Predicates (guesses) used for searching / titles.
 * If your dataset uses different IRIs, it still works with "Any field".
 */
const TITLE_PREDICATES = [
  "http://example.org/property/title",
  "http://example.org/property/book",
  "http://purl.org/dc/terms/title",
  "http://www.w3.org/2000/01/rdf-schema#label",
  "http://schema.org/name"
];

const SUBJECT_PREDICATES = [
  "http://example.org/property/subject",
  "http://purl.org/dc/terms/subject",
  "http://schema.org/about"
];

function buildSearchQuery(term, field, limit=25, offset=0) {
  const t = esc(term);

  if (field === "title") {
    return `
SELECT DISTINCT ?book ?label
WHERE {
  ?book ?p ?label .
  VALUES ?p { ${TITLE_PREDICATES.map(u => `<${u}>`).join(" ")} }
  FILTER(CONTAINS(LCASE(STR(?label)), LCASE("${t}")))
}
ORDER BY STR(?book)
LIMIT ${limit}
OFFSET ${offset}
`.trim();
  }

  if (field === "subject") {
    return `
SELECT DISTINCT ?book ?label
WHERE {
  ?book ?p ?label .
  VALUES ?p { ${SUBJECT_PREDICATES.map(u => `<${u}>`).join(" ")} }
  FILTER(CONTAINS(LCASE(STR(?label)), LCASE("${t}")))
}
ORDER BY STR(?book)
LIMIT ${limit}
OFFSET ${offset}
`.trim();
  }

  return `
SELECT DISTINCT ?book ?label
WHERE {
  ?book ?p ?label .
  FILTER(CONTAINS(LCASE(STR(?label)), LCASE("${t}")))
}
ORDER BY STR(?book)
LIMIT ${limit}
OFFSET ${offset}
`.trim();
}

function subjectsForBookQuery(bookIri, limit=30) {
  return `
SELECT DISTINCT ?subj
WHERE {
  <${bookIri}> ?p ?subj .
  VALUES ?p { ${SUBJECT_PREDICATES.map(u => `<${u}>`).join(" ")} }
}
LIMIT ${limit}
`.trim();
}

function booksBySubjectValueQuery(subjectValue, limit=25) {
  const t = esc(subjectValue);
  return `
SELECT DISTINCT ?book ?title
WHERE {
  ?book ?p ?subj .
  VALUES ?p { ${SUBJECT_PREDICATES.map(u => `<${u}>`).join(" ")} }
  FILTER(CONTAINS(LCASE(STR(?subj)), LCASE("${t}")))

  OPTIONAL { ?book <http://example.org/property/title> ?title }
  OPTIONAL { ?book <http://example.org/property/book> ?title }
  OPTIONAL { ?book <http://www.w3.org/2000/01/rdf-schema#label> ?title }
  OPTIONAL { ?book <http://schema.org/name> ?title }
}
ORDER BY STR(?book)
LIMIT ${limit}
`.trim();
}

/** Fetch ALL data for a book: <book> ?p ?o */
function allDataForBookQuery(bookIri, limit=500) {
  return `
SELECT ?p ?o
WHERE {
  <${bookIri}> ?p ?o .
}
ORDER BY STR(?p) STR(?o)
LIMIT ${limit}
`.trim();
}

// --------------------
// Details panel rendering
// --------------------
function renderBookDetails({ iri, label, triples, subjects }) {
  const subjectChips = (subjects || []).map(s => {
    const display = shortLabel(s);
    const safe = s.replace(/"/g, '&quot;');
    return `<span class="badge" data-action="subject" data-value="${safe}">${display}</span>`;
  }).join("");

  // Group predicate -> values
  const map = new Map();
  for (const { p, o, oType } of triples) {
    const key = p;
    if (!map.has(key)) map.set(key, []);
    map.get(key).push({ o, oType });
  }

  // Turn into rows
  const rowsHtml = Array.from(map.entries()).map(([p, values]) => {
    const pk = shortLabel(p);
    const vals = values.map(v => {
      if (v.oType === "uri") {
        const disp = shortLabel(v.o);
        // clicking URI in panel selects node if exists; otherwise tries to pivot search
        return `<a href="#" data-action="uri" data-value="${v.o.replace(/"/g, '&quot;')}">${disp}</a>`;
      } else {
        return shortLabel(v.o);
      }
    }).join("<br/>");
    return `<div class="k">${pk}</div><div class="v">${vals}</div>`;
  }).join("");

  panelEl.innerHTML = `
    <div class="card">
      <h2>${label}</h2>
      <div class="sub">${iri}</div>

      <div class="actions">
        ${subjects && subjects.length ? `<span class="hint"><b>Subjects:</b></span>${subjectChips}` : `<span class="hint">No subjects found for this record.</span>`}
      </div>
    </div>

    <div class="card">
      <div class="hint" style="margin-bottom:10px;">
        <b>All fields</b> (showing ${triples.length} triple(s))
      </div>
      <div class="kv">
        ${rowsHtml || `<div class="hint">No data found for this record.</div>`}
      </div>
    </div>
  `;

  // Wire panel clicks
  panelEl.querySelectorAll('[data-action="subject"]').forEach(el => {
    el.addEventListener("click", async () => {
      const val = el.getAttribute("data-value");
      await expandSubject(val);
    });
  });

  panelEl.querySelectorAll('[data-action="uri"]').forEach(el => {
    el.addEventListener("click", (e) => {
      e.preventDefault();
      const uri = el.getAttribute("data-value");
      selectOrAddUri(uri);
    });
  });
}

function selectOrAddUri(uri) {
  // If it's already a node, select and center it
  const existing = cy.getElementById(uri);
  if (!existing.empty()) {
    cy.elements().unselect();
    existing.select();
    cy.animate({ center: { eles: existing }, duration: 250 });
    status(`Selected: ${existing.data("label")}`);
    return;
  }

  // If not, add a node (so the panel link feels useful)
  ensureNode(uri, shortLabel(uri), "subject", { kind: "subject", subjectValue: uri });
  relayout();
  status("Added node from details panel.");
}

// --------------------
// App state + search
// --------------------
let currentTermNodeId = null;
let currentOffset = 0;
const PAGE_SIZE = 25;

async function runSearch(reset=true) {
  const term = qEl.value.trim();
  const field = fieldEl.value;
  if (!term) { status("Type a search term."); return; }

  if (reset) {
    cy.elements().remove();
    currentOffset = 0;
    currentTermNodeId = `term:${field}:${term.toLowerCase()}`;
    ensureNode(currentTermNodeId, term, "term", { kind: "term", term, field });

    panelEl.innerHTML = `
      <div class="card">
        <h2>Book details</h2>
        <div class="sub">Click a book node to see all associated data here.</div>
      </div>
    `;
    status(`Searching ${field} for "${term}"…`);
  }

  const json = await sparql(buildSearchQuery(term, field, PAGE_SIZE, currentOffset));
  const rows = json?.results?.bindings || [];

  if (!rows.length && currentOffset === 0) {
    relayout();
    status(`No results for "${term}" in ${field}. Try "Any field" or a different keyword.`);
    return;
  }

  for (const row of rows) {
    const book = row.book?.value;
    const label = row.label?.value;
    if (!book) continue;

    ensureNode(book, shortLabel(label || book), "book", { kind: "book", iri: book });
    ensureEdge(`${currentTermNodeId}|matches|${book}`, currentTermNodeId, book, "matches");
  }

  currentOffset += PAGE_SIZE;
  relayout();
  status(`Loaded ${cy.nodes(".book").length} result book(s). Click a book to reveal subjects + details.`);
}

document.getElementById("searchBtn").addEventListener("click", () => runSearch(true));
qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") runSearch(true); });

document.getElementById("clearBtn").addEventListener("click", () => {
  cy.elements().remove();
  currentTermNodeId = null;
  currentOffset = 0;
  panelEl.innerHTML = `
    <div class="card">
      <h2>Book details</h2>
      <div class="sub">Click a book node to see all associated data here.</div>
    </div>
  `;
  status("Cleared.");
});

document.getElementById("fitBtn").addEventListener("click", () => cy.fit());

// --------------------
// Click behaviors
// --------------------
async function expandSubject(subjectValue) {
  const subjLabel = shortLabel(subjectValue);
  status(`Loading more books in subject "${subjLabel}"…`);

  const json = await sparql(booksBySubjectValueQuery(subjectValue, 25));
  const rows = json?.results?.bindings || [];

  const subjId = "subject:" + subjectValue.toLowerCase();
  ensureNode(subjId, subjLabel, "subject", { kind: "subject", subjectValue });

  let added = 0;
  for (const row of rows) {
    const book = row.book?.value;
    const title = row.title?.value;
    if (!book) continue;

    ensureNode(book, shortLabel(title || book), "book", { kind: "book", iri: book });
    ensureEdge(`${subjId}|hasBook|${book}`, subjId, book, "has book");
    added++;
  }

  relayout();
  status(added ? `Added ${added} book(s) for subject "${subjLabel}".` : `No additional books found for subject "${subjLabel}".`);
}

async function loadBookDetails(bookIri, bookLabel) {
  status("Loading full record…");

  // 1) fetch all triples
  const allJson = await sparql(allDataForBookQuery(bookIri, 500));
  const rows = allJson?.results?.bindings || [];
  const triples = rows.map(r => ({
    p: r.p?.value,
    o: r.o?.value,
    oType: r.o?.type || (r.o?.value?.startsWith("http") ? "uri" : "literal")
  })).filter(x => x.p && x.o);

  // 2) fetch subjects (for chips)
  let subjects = [];
  try {
    const subjJson = await sparql(subjectsForBookQuery(bookIri, 50));
    const subjRows = subjJson?.results?.bindings || [];
    subjects = subjRows.map(r => r.subj?.value).filter(Boolean);
  } catch (e) {
    // ok if subject predicates are different; panel still shows all fields
    console.warn("Subjects query failed:", e);
  }

  renderBookDetails({
    iri: bookIri,
    label: bookLabel || shortLabel(bookIri),
    triples,
    subjects
  });

  status("Record loaded.");
}

// Clicking a BOOK: add subjects to graph + load details
cy.on("tap", "node", async (evt) => {
  const node = evt.target;
  const kind = node.data("kind");
  if (kind !== "book") return;

  const bookIri = node.data("iri") || node.id();
  const bookLabel = node.data("label") || shortLabel(bookIri);

  cy.elements().unselect();
  node.select();

  // Show immediate panel header while fetching
  panelEl.innerHTML = `
    <div class="card">
      <h2>${bookLabel}</h2>
      <div class="sub">${bookIri}</div>
      <div class="hint">Loading full record…</div>
    </div>
  `;

  // Add subject nodes/edges to graph (discovery)
  try {
    const subjJson = await sparql(subjectsForBookQuery(bookIri, 30));
    const subjRows = subjJson?.results?.bindings || [];
    for (const r of subjRows) {
      const subjVal = r.subj?.value;
      if (!subjVal) continue;
      const subjId = "subject:" + subjVal.toLowerCase();
      ensureNode(subjId, shortLabel(subjVal), "subject", { kind: "subject", subjectValue: subjVal });
      ensureEdge(`${bookIri}|subject|${subjId}`, bookIri, subjId, "subject");
    }
  } catch (e) {
    console.warn("Subject expansion failed:", e);
  }

  relayout();

  // Load full record details (panel)
  try {
    await loadBookDetails(bookIri, bookLabel);
  } catch (e) {
    panelEl.innerHTML = `
      <div class="card">
        <h2>${bookLabel}</h2>
        <div class="sub">${bookIri}</div>
        <div class="hint">Could not load full record. Open DevTools → Console for details.</div>
      </div>
    `;
    status(e.message);
  }
});

// Clicking a SUBJECT node: load more books in that subject
cy.on("tap", "node.subject", async (evt) => {
  const subjVal = evt.target.data("subjectValue");
  if (!subjVal) return;
  cy.elements().unselect();
  evt.target.select();
  await expandSubject(subjVal);
});

status('Type a search term (e.g. "psychology"). Default is Title. Click a book for full details.');
</script>
</body>
</html>
